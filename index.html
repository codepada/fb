<!DOCTYPE html> //3
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit Control & Sensors (MQTT)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e0e0e0; }
        .btn { @apply px-6 py-3 rounded-lg font-semibold shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 text-white; }
    </style>
</head>
<body class="bg-gray-900 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Control Panel Section -->
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl mx-auto text-center mb-8">
        <h1 class="text-4xl font-bold mb-6 text-emerald-400">แผงควบคุม Micro:bit</h1>
        <p class="text-lg mb-8 text-gray-400">ควบคุมสถานะของขา P0, P1, P8, P12, P2, P13, P14, P15, P16</p>
        <div id="pin-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-8"></div>
    </div>
    
    <!-- Sensor Input Section -->
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-6 text-sky-400">ข้อมูลเซนเซอร์แบบเรียลไทม์</h2>
        <p class="text-lg mb-8 text-gray-400">อ่านค่า Input จากขา Micro:bit ที่กำหนด</p>
        <div id="sensor-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8"></div>
        <div id="status-message" class="mt-4 text-center">
            <p id="connection-status" class="text-yellow-400">กำลังเชื่อมต่อกับ MQTT Broker...</p>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script>
        // --- MQTT Setup ---
        const MQTT_BROKER = "broker.hivemq.com";
        // เปลี่ยนมาใช้ WebSocket Port ที่ปลอดภัย (WSS) เพื่อหลีกเลี่ยงปัญหาการบล็อก
        const MQTT_PORT = 8084;
        
        // ใช้ UNIQUE_ID ตัวเดียวกันกับในโค้ด Micro:bit
        const UNIQUE_ID = "11222222";
        const MQTT_COMMAND_TOPIC = "microbit/" + UNIQUE_ID + "/command";
        const MQTT_SENSORS_TOPIC = "microbit/" + UNIQUE_ID + "/sensors";

        // กำหนดการเชื่อมต่อโดยใช้ WebSocket
        const client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "web-client-" + parseInt(Math.random() * 100, 10));

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        // ส่ง options เพื่อใช้ WebSocket
        client.connect({
            onSuccess: onConnect,
            useSSL: true, // ตั้งค่าเป็น true เพื่อใช้ SSL/TLS
        });

        function onConnect() {
            console.log("Connected to MQTT Broker");
            document.getElementById('connection-status').textContent = "เชื่อมต่อเรียบร้อยแล้ว!";
            document.getElementById('connection-status').className = "text-green-500";
            client.subscribe(MQTT_SENSORS_TOPIC);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                document.getElementById('connection-status').textContent = "ขาดการเชื่อมต่อ!";
                document.getElementById('connection-status').className = "text-red-500";
            }
        }

        function onMessageArrived(message) {
            console.log("Message Arrived: " + message.payloadString);
            const sensorData = message.payloadString;

            const sensorPairs = sensorData.split(',');
            sensorPairs.forEach(pair => {
                const [pinName, value] = pair.split(':');
                const pinNum = parseInt(pinName.replace('P', ''), 10);
                if (!isNaN(pinNum)) {
                    const valueElement = document.getElementById(`sensor-p${pinNum}-value`);
                    if (valueElement) {
                        valueElement.textContent = value;
                    }
                }
            });
        }
        
        const outputPins = [0, 1, 8, 12, 2, 13, 14, 15, 16];
        const outputPinsState = {};
        const pinContainer = document.getElementById('pin-container');

        const inputPins = [1, 2, 5, 8, 11, 12, 13, 14, 15, 16];
        const sensorContainer = document.getElementById('sensor-container');

        function updateOutputPinUI(pin, state) {
            const button = document.getElementById(`pin-${pin}-btn`);
            if (button) {
                if (state === "On") {
                    button.classList.remove('bg-red-500', 'hover:bg-red-600');
                    button.classList.add('bg-green-500', 'hover:bg-green-600');
                    button.textContent = `P${pin} (On)`;
                } else {
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-red-500', 'hover:bg-red-600');
                    button.textContent = `P${pin} (Off)`;
                }
            }
        }

        outputPins.forEach(pin => {
            outputPinsState[pin] = "Off";
            const button = document.createElement('button');
            button.id = `pin-${pin}-btn`;
            button.className = 'btn bg-red-500 hover:bg-red-600';
            button.textContent = `P${pin} (Off)`;
            button.onclick = () => {
                const newState = outputPinsState[pin] === "On" ? "Off" : "On";
                const command = `P${pin}_${newState}`;
                const message = new Paho.MQTT.Message(command);
                message.destinationName = MQTT_COMMAND_TOPIC;
                client.send(message);
                outputPinsState[pin] = newState;
                updateOutputPinUI(pin, newState);
            };
            pinContainer.appendChild(button);
        });

        inputPins.forEach(pin => {
            const sensorCard = document.createElement('div');
            sensorCard.className = 'bg-gray-700 p-4 rounded-lg shadow-inner';
            sensorCard.innerHTML = `
                <h3 class="text-xl font-bold text-sky-300">Pin P${pin}</h3>
                <p class="text-lg mt-2 text-gray-300">Current Value: <span id="sensor-p${pin}-value" class="font-mono text-xl text-yellow-300">--</span></p>
            `;
            sensorContainer.appendChild(sensorCard);
        });
    </script>
</body>
</html>
