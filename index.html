<!DOCTYPE html>

<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุม Micro:bit</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center mb-2 text-indigo-600">
            แผงควบคุม Micro:bit
        </h1>
        <p class="text-center text-gray-500 mb-6">
            ควบคุมขา P0, P1, P2, P12, P13, P14, P15, P16
        </p>

        <div id="status-message" class="text-center p-3 mb-4 rounded-lg font-medium text-sm">
            กำลังเชื่อมต่อกับ MQTT...
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <!-- P0 -->
            <button id="p0-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P0 (On)
            </button>
            <button id="p0-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P0 (Off)
            </button>
            <!-- P1 -->
            <button id="p1-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P1 (On)
            </button>
            <button id="p1-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P1 (Off)
            </button>
            <!-- P2 -->
            <button id="p2-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P2 (On)
            </button>
            <button id="p2-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P2 (Off)
            </button>
            <!-- P12 -->
            <button id="p12-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P12 (On)
            </button>
            <button id="p12-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P12 (Off)
            </button>
            <!-- P13 -->
            <button id="p13-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P13 (On)
            </button>
            <button id="p13-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P13 (Off)
            </button>
            <!-- P14 -->
            <button id="p14-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P14 (On)
            </button>
            <button id="p14-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P14 (Off)
            </button>
            <!-- P15 -->
            <button id="p15-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P15 (On)
            </button>
            <button id="p15-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P15 (Off)
            </button>
            <!-- P16 -->
            <button id="p16-on" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P16 (On)
            </button>
            <button id="p16-off" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors">
                P16 (Off)
            </button>
        </div>

        <!-- Sensor Data Display -->
        <div class="bg-gray-50 rounded-lg p-4 shadow-inner">
            <h3 class="text-xl font-semibold mb-2 text-gray-700">ข้อมูลเซนเซอร์</h3>
            <div id="sensor-data" class="text-gray-600 font-mono text-sm">
                ไม่มีข้อมูลเซนเซอร์
            </div>
        </div>
    </div>

    <script>
        const MQTT_BROKER = "broker.hivemq.com";
        const UNIQUE_ID = "11222222";
        // Fixed: Use UNIQUE_ID variable to construct the topic string
        const TOPIC = `microbit/${UNIQUE_ID}/command`;
        const SENSORS_TOPIC = `microbit/${UNIQUE_ID}/sensors`;
        
        const statusMessage = document.getElementById('status-message');

        function updateStatus(message, type) {
            statusMessage.textContent = message;
            if (type === 'success') {
                statusMessage.className = 'text-center p-3 mb-4 rounded-lg font-medium text-sm bg-green-200 text-green-800';
            } else if (type === 'error') {
                statusMessage.className = 'text-center p-3 mb-4 rounded-lg font-medium text-sm bg-red-200 text-red-800';
            } else {
                statusMessage.className = 'text-center p-3 mb-4 rounded-lg font-medium text-sm bg-blue-200 text-blue-800';
            }
        }

        const client = mqtt.connect(`wss://${MQTT_BROKER}:8884`);

        client.on('connect', function () {
            console.log('Connected to MQTT Broker!');
            updateStatus('เชื่อมต่อสำเร็จ!', 'success');
            client.subscribe(SENSORS_TOPIC, function (err) {
                if (!err) {
                    console.log(`Subscribed to ${SENSORS_TOPIC}`);
                }
            });
        });

        client.on('error', function (error) {
            console.error('MQTT connection error:', error);
            updateStatus('เกิดข้อผิดพลาดในการเชื่อมต่อ!', 'error');
        });

        client.on('message', function (topic, message) {
            // message is a Buffer
            const sensorData = message.toString();
            console.log(`Received sensor data from MQTT: ${sensorData}`);
            document.getElementById('sensor-data').textContent = sensorData;
        });

        function publishCommand(command) {
            if (client.connected) {
                client.publish(TOPIC, command);
                console.log(`Published command to MQTT: ${command}`);
            } else {
                console.error('Client is not connected to MQTT broker.');
                updateStatus('ไม่สามารถส่งคำสั่งได้: ไม่ได้เชื่อมต่อ!', 'error');
            }
        }

        document.getElementById('p0-on').addEventListener('click', () => publishCommand('P0_On'));
        document.getElementById('p0-off').addEventListener('click', () => publishCommand('P0_Off'));
        document.getElementById('p1-on').addEventListener('click', () => publishCommand('P1_On'));
        document.getElementById('p1-off').addEventListener('click', () => publishCommand('P1_Off'));
        document.getElementById('p2-on').addEventListener('click', () => publishCommand('P2_On'));
        document.getElementById('p2-off').addEventListener('click', () => publishCommand('P2_Off'));
        document.getElementById('p12-on').addEventListener('click', () => publishCommand('P12_On'));
        document.getElementById('p12-off').addEventListener('click', () => publishCommand('P12_Off'));
        document.getElementById('p13-on').addEventListener('click', () => publishCommand('P13_On'));
        document.getElementById('p13-off').addEventListener('click', () => publishCommand('P13_Off'));
        document.getElementById('p14-on').addEventListener('click', () => publishCommand('P14_On'));
        document.getElementById('p14-off').addEventListener('click', () => publishCommand('P14_Off'));
        document.getElementById('p15-on').addEventListener('click', () => publishCommand('P15_On'));
        document.getElementById('p15-off').addEventListener('click', () => publishCommand('P15_Off'));
        document.getElementById('p16-on').addEventListener('click', () => publishCommand('P16_On'));
        document.getElementById('p16-off').addEventListener('click', () => publishCommand('P16_Off'));
    </script>
</body>
</html>
