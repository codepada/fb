<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit Output Control</title>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <!-- Paho MQTT JavaScript Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-primary {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Styles for the new toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #22c55e; /* green-500 */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 sm:p-6">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-lg space-y-6">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-600">
                    ควบคุม Micro:bit
                </span>
            </h1>
            <p id="status" class="mt-2 text-sm text-gray-500 font-medium">สถานะ: ไม่ได้เชื่อมต่อ</p>
        </header>

        <!-- Connection Settings Section -->
        <section class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                <label for="uniqueId" class="block text-sm font-medium text-gray-700">ID เฉพาะ (ต้องตรงกับ Micro:bit)</label>
                <input type="text" id="uniqueId" value="11222222" placeholder="ใส่ ID เฉพาะที่นี่"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
            <button id="connectBtn"
                class="w-full bg-gradient-primary text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hover:opacity-90">
                เชื่อมต่อกับ Broker
            </button>
        </section>

        <!-- Pin Control Section -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">ควบคุมพินดิจิตอล</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="pin-control-container">
                <!-- Pin 0 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 0</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P0" onchange="handleToggleChange('P0', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 1 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 1</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P1" onchange="handleToggleChange('P1', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- NEW: Pin 2 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 2</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P2" onchange="handleToggleChange('P2', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 8 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 8</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P8" onchange="handleToggleChange('P8', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 12 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 12</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P12" onchange="handleToggleChange('P12', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 13 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 13</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P13" onchange="handleToggleChange('P13', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 14 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 14</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P14" onchange="handleToggleChange('P14', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 15 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 15</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P15" onchange="handleToggleChange('P15', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Pin 16 Control -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 flex justify-between items-center">
                    <span class="text-base font-semibold text-gray-700 whitespace-nowrap">Pin 16</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-P16" onchange="handleToggleChange('P16', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- MQTT Broker & Client Configuration ---
        const HOST = 'broker.hivemq.com';
        const PORT = 8884; // Secure WebSocket Port
        let client;
        let uniqueId;
        const statusElement = document.getElementById('status');

        // --- Event Listener for Page Load ---
        window.onload = function() {
            // Check if Paho library is loaded.
            if (typeof Paho === 'undefined' || !Paho.MQTT || !Paho.MQTT.Client) {
                statusElement.textContent = "Error: Paho script not loaded.";
                statusElement.style.color = "red";
                console.error("Paho MQTT client is not loaded. Check the script link or internet connection.");
                return;
            }
            initializeMQTT();
        };

        // --- Main MQTT Initialization Function ---
        function initializeMQTT() {
            document.getElementById('connectBtn').addEventListener('click', () => {
                uniqueId = document.getElementById('uniqueId').value;
                if (!uniqueId) {
                    statusElement.textContent = "Error: Please enter a unique ID.";
                    statusElement.style.color = "red";
                    return;
                }
                connectMQTT();
            });

            function connectMQTT() {
                statusElement.textContent = "สถานะ: กำลังเชื่อมต่อ...";
                statusElement.style.color = "black";
                
                // Client ID must be unique
                const clientId = "web-" + Math.random().toString(16).substr(2, 8);
                client = new Paho.MQTT.Client(HOST, PORT, "/mqtt", clientId);

                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived; // This function is still needed to confirm successful connection messages

                try {
                    client.connect({
                        onSuccess: onConnect,
                        useSSL: true, // IMPORTANT for secure connection
                        timeout: 5,
                        onFailure: onFail
                    });
                } catch (e) {
                    statusElement.textContent = `Error: ${e.message}`;
                    statusElement.style.color = "red";
                    console.error("MQTT connection failed:", e);
                }
            }

            function onConnect() {
                console.log("Connected to MQTT Broker.");
                statusElement.textContent = "สถานะ: เชื่อมต่อแล้ว";
                statusElement.style.color = "green";

                // No need to subscribe to a sensor topic anymore
            }

            function onFail(responseObject) {
                console.log("Connection failed: " + responseObject.errorMessage);
                statusElement.textContent = `สถานะ: การเชื่อมต่อล้มเหลว (${responseObject.errorMessage})`;
                statusElement.style.color = "red";
            }

            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("Connection lost: " + responseObject.errorMessage);
                    statusElement.textContent = `สถานะ: การเชื่อมต่อหลุด (${responseObject.errorMessage})`;
                    statusElement.style.color = "red";
                }
            }
            
            // This function is now simplified as it no longer needs to process sensor data.
            // It will only receive messages for debugging or future features if added.
            function onMessageArrived(message) {
                console.log("Message arrived on topic " + message.destinationName + ": " + message.payloadString);
            }
        }

        // --- New Function to Handle Toggle Switch Changes ---
        window.handleToggleChange = function(pin, isChecked) {
            const state = isChecked ? 'On' : 'Off';
            publishCommand(pin, state);
        }

        // --- Function to Publish Commands ---
        function publishCommand(pin, state) {
            if (!client || !client.isConnected()) {
                statusElement.textContent = "Error: Not connected to MQTT.";
                statusElement.style.color = "red";
                // Reset the toggle switch state
                const toggle = document.getElementById(`toggle-${pin}`);
                toggle.checked = !toggle.checked;
                return;
            }

            const topic = `${uniqueId}/commands`;
            const payload = `${pin}_${state}`;
            
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            
            try {
                client.send(message);
                console.log(`Published to ${topic}: ${payload}`);
            } catch (e) {
                statusElement.textContent = `Error publishing: ${e.message}`;
                statusElement.style.color = "red";
                console.error("Publishing failed:", e);
                // Reset the toggle switch state on failure
                const toggle = document.getElementById(`toggle-${pin}`);
                toggle.checked = !toggle.checked;
            }
        }
    </script>
</body>
</html>
