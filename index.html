<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit MQTT Control</title>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Paho MQTT JavaScript Client - Updated to a stable version (1.1.0) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-primary {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .bg-gradient-secondary {
            background-image: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .btn-pin {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 sm:p-6">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-lg space-y-6">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-600">
                    ควบคุม Micro:bit
                </span>
            </h1>
            <p id="status" class="mt-2 text-sm text-gray-500 font-medium">สถานะ: ไม่ได้เชื่อมต่อ</p>
        </header>

        <!-- Connection Settings Section -->
        <section class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm">
                <label for="uniqueId" class="block text-sm font-medium text-gray-700">ID เฉพาะ (ต้องตรงกับ Micro:bit)</label>
                <input type="text" id="uniqueId" value="11222222" placeholder="ใส่ ID เฉพาะที่นี่"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
            <button id="connectBtn"
                class="w-full bg-gradient-primary text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hover:opacity-90">
                เชื่อมต่อกับ Broker
            </button>
        </section>

        <!-- Pin Control Section -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">ควบคุมพินดิจิตอล</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <!-- Buttons for Digital Pins -->
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 0</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P0', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P0', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 1</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P1', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P1', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 8</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P8', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P8', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 12</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P12', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P12', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 13</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P13', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P13', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 14</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P14', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P14', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 15</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P15', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P15', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-md border border-gray-200 btn-pin">
                    <span class="text-base font-semibold text-gray-700">Pin 16</span>
                    <div class="flex space-x-2">
                        <button onclick="publishCommand('P16', 'On')" class="px-3 py-1 text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">เปิด</button>
                        <button onclick="publishCommand('P16', 'Off')" class="px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">ปิด</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sensor Data Display Section -->
        <section class="space-y-2">
            <h2 class="text-xl font-semibold text-gray-700">ค่าเซนเซอร์</h2>
            <div id="sensor-data" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-3 bg-gray-50 rounded-lg shadow-sm">
                    <span class="block text-sm font-medium text-gray-700">ข้อมูลจากเซนเซอร์จะแสดงที่นี่</span>
                </div>
            </div>
        </section>
    </div>

    <script>
        // MQTT Broker Settings - ต้องตรงกับ ESP32 และ Micro:bit
        // หน้าเว็บต้องใช้พอร์ต WebSocket
        const HOST = 'broker.hivemq.com';
        const PORT = 8884; // Secure WebSocket Port for broker.hivemq.com
        const PROTOCOL = 'wss'; // Encrypted WebSocket
        
        let client;
        let uniqueId;
        const statusElement = document.getElementById('status');

        document.getElementById('connectBtn').addEventListener('click', () => {
            uniqueId = document.getElementById('uniqueId').value;
            if (!uniqueId) {
                statusElement.textContent = "Error: Please enter a unique ID.";
                statusElement.style.color = "red";
                return;
            }
            connectMQTT();
        });

        // Function to establish MQTT connection
        function connectMQTT() {
            statusElement.textContent = "สถานะ: กำลังเชื่อมต่อ...";
            statusElement.style.color = "black";
            // Paho requires the /mqtt path for WSS connections
            client = new Paho.MQTT.Client(HOST, PORT, "/mqtt", "web-" + Math.random().toString(16).substr(2, 8));

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            try {
                // useSSL: true is required for wss:// protocol
                client.connect({
                    onSuccess: onConnect,
                    useSSL: true, // IMPORTANT: Set to true for secure connection
                    timeout: 3, // 3 seconds timeout
                    onFailure: onFail
                });
            } catch (e) {
                statusElement.textContent = "Error: " + e.message;
                statusElement.style.color = "red";
            }
        }

        // Called when the connection is successful
        function onConnect() {
            console.log("Connected to MQTT Broker.");
            statusElement.textContent = "สถานะ: เชื่อมต่อแล้ว";
            statusElement.style.color = "green";

            // Subscribe to the sensor data topic
            const sensorTopic = `${uniqueId}/sensors`;
            client.subscribe(sensorTopic);
            console.log(`Subscribed to topic: ${sensorTopic}`);
        }
        
        // Called when the connection fails
        function onFail(responseObject) {
            console.log("Connection failed: " + responseObject.errorMessage);
            statusElement.textContent = `สถานะ: การเชื่อมต่อล้มเหลว (${responseObject.errorMessage})`;
            statusElement.style.color = "red";
        }

        // Called when the connection is lost
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
                statusElement.textContent = `สถานะ: การเชื่อมต่อหลุด (${responseObject.errorMessage})`;
                statusElement.style.color = "red";
            }
        }

        // Called when a message arrives
        function onMessageArrived(message) {
            console.log("Message arrived on topic " + message.destinationName + ": " + message.payloadString);
            const payload = message.payloadString;
            const sensorDataElement = document.getElementById('sensor-data');

            // Handle sensor data messages
            if (payload.startsWith("sensors:")) {
                const dataString = payload.substring(8);
                const dataPairs = dataString.split(',');
                
                let htmlContent = '';
                dataPairs.forEach(pair => {
                    const [pin, value] = pair.split(':');
                    htmlContent += `
                        <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                            <span class="block text-sm font-medium text-gray-500">${pin}</span>
                            <span class="block text-xl font-bold text-gray-800">${value}</span>
                        </div>
                    `;
                });
                if (htmlContent) {
                    sensorDataElement.innerHTML = htmlContent;
                }
            }
        }
        
        // Function to publish commands to the Micro:bit
        function publishCommand(pin, state) {
            if (!client || !client.isConnected()) {
                statusElement.textContent = "Error: Not connected to MQTT.";
                statusElement.style.color = "red";
                return;
            }

            const topic = `${uniqueId}/commands`;
            const payload = `${pin}_${state}`;
            
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            
            try {
                client.send(message);
                console.log(`Published to ${topic}: ${payload}`);
            } catch (e) {
                statusElement.textContent = `Error publishing: ${e.message}`;
                statusElement.style.color = "red";
            }
        }
    </script>
</body>
</html>
